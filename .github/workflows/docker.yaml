name: Docker Build and Publish

on:
#   workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build_and_publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Get version from package.json
      id: get_version
      run: echo "::set-output name=version::$(node -p -e "require('./package.json').version")"

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v2
      with:
        context: .
        push: true
        tags: mazurovsasha/project:${{ steps.get_version.outputs.version }}

    - name: Checkout values.yaml
      uses: actions/checkout@v2
      with:
        repository: Mazurovsasha/project-helm
        path: ./temp
        token: ${{ secrets.PROJECT_TOKEN }}

    - name: Update values.yaml
      run: |
        sed -i 's/tag:.*/tag: ${{ steps.get_version.outputs.version }}/g' ./temp/project/values.yaml
        cat ./temp/project/values.yaml
      
    - name: Commit and push changes to values.yaml
      run: |
        git config --global user.email "mazurovsasha@gmail.com"
        git config --global user.name "Alexsandr Mazurov"
        git add .
        git commit -m "Update values.yaml v${{ steps.get_version.outputs.version }}"
        git remote add helm-origin https://github.com/Mazurovsasha/project-helm.git
        export GH_TOKEN=${{ secrets.PROJECT_TOKEN }}
        git push --force --set-upstream helm-origin master "${GH_TOKEN}"